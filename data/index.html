<!DOCTYPE html>
<html>
  <head>
    <title>Aura2 Settings</title>
  </head>
  <body>
    <div>
      <h1>
        <img src="logo.png" alt="Logo" width="20" />
        Aura2 Settings
      </h1>
    </div>

    <div>
        <button onclick="detectLocation()">Detect Location</button>
        <p id="locationStatus">%WEATHER_CITY%, %WEATHER_REGION%</p>
        <div style="margin-left: 20px">
            Latitude: %CURRENT_LAT%
            <br />
            Longitude: %CURRENT_LON%
        </div>
    </div>

    <div>
      Brightness:
      <input
        type="range"
        min="0"
        max="255"
        value="%BRIGHTNESS_VALUE%"
        id="brightnessSlider"
        oninput="updateBrightness(this.value)"
      />
    </div>
    <div>
      Use 24-hour clock:
      <input
        type="checkbox"
        id="clockFormat24"
        onchange="updateClockFormat(this.checked)"
        %CLOCK_24H_CHECKED%
      />
    </div>
    <div>
      Use Fahrenheit:
      <input
        type="checkbox"
        id="tempFormatF"
        onchange="updateTempFormat(this.checked)"
        %TEMP_F_CHECKED%
      />
    </div>
    <div id="dimAtTimeSettings">
      <div id="dimAtTimeSetting">
        Dim at night:
        <input
          type="checkbox"
          id="dimAtTime"
          onchange="updateDimAtTime(this.checked)"
          %DIM_AT_TIME_CHECKED%
        />
      </div>
      <div style="margin-left: 20px">
        <div id="dimStartTimeSetting">
          Start:
          <input
            type="time"
            id="dimStartTime"
            value="%DIM_START_TIME%"
            onchange="updateDimStartTime(this.value)"
          />
        </div>
        <div id="dimEndTimeSetting">
          End:
          <input
            type="time"
            id="dimEndTime"
            value="%DIM_END_TIME%"
            onchange="updateDimEndTime(this.value)"
          />
        </div>
      </div>
    </div>
    <script>
      function detectLocation() {
        document.getElementById("locationStatus").textContent = "Detecting...";
        
        // Use ESP32 proxy endpoint instead of direct external API call
        fetch("/detectLocation", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({}) // Empty body for proxy request
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === "ok") {
            const lat = data.latitude;
            const lon = data.longitude;
            const location = data.city && data.region ? `${data.city}, ${data.region}` : `${lat}, ${lon}`;
            
            document.getElementById("locationStatus").textContent = `Detected: ${location}`;
            console.log("Location detected and saved to ESP32");
          } else {
            document.getElementById("locationStatus").textContent = `Error: ${data.error}`;
            console.error("Location detection failed:", data.error);
          }
        })
        .catch(err => {
          document.getElementById("locationStatus").textContent = "Detection failed";
          console.error("Network error:", err);
        });
      }

      function updateBrightness(val) {
        fetch("/setBrightness", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ value: parseInt(val) }),
        });
      }

      function updateClockFormat(is24Hour) {
        fetch("/setClockFormat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ format24: is24Hour }),
        });
      }

      function updateTempFormat(isFahrenheit) {
        fetch("/setTempFormat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ useF: isFahrenheit }),
        });
      }

      function updateDimAtTime(isEnabled) {
        fetch("/setDimAtTime", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ enabled: isEnabled }),
        });
      }

      function updateDimStartTime(time) {
        fetch("/setDimStartTime", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ startTime: time }),
        });
      }

      function updateDimEndTime(time) {
        fetch("/setDimEndTime", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ endTime: time }),
        });
      }
    </script>
  </body>
</html>
