<!DOCTYPE html>
<html>

<head>
  <title>Aura2 Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #24374a;
      min-height: 100vh;
      padding: 10px;
      color: #333;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(45deg, #2196F3, #21CBF3);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .header h1 {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 28px;
      font-weight: 600;
    }

    .content {
      padding: 20px;
    }

    .setting-group {
      margin-bottom: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-left: 4px solid #2a4c66;
    }

    .setting-label {
      display: block;
      font-weight: 600;
      color: #555;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .location-section {
      text-align: center;
    }

    .detect-btn {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .detect-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    .location-info {
      margin-top: 10px;
      padding: 8px;
      background: white;
      border-radius: 6px;
      font-size: 14px;
    }

    .coordinates {
      margin-top: 6px;
      font-size: 12px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .brightness-container {
      position: relative;
    }

    .brightness-slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #ddd;
      outline: none;
      cursor: pointer;
    }

    .brightness-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #2196F3;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .brightness-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #2196F3;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .toggle-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 28px;
      background: #ccc;
      border-radius: 14px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch input:checked+.toggle-slider {
      transform: translateX(22px);
    }

    .toggle-switch input:checked {
      background: #2196F3;
    }

    .toggle-switch:has(input:checked) {
      background: #2196F3;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .text-input,
    .time-input {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .text-input:focus,
    .time-input:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    .coordinates-input {
      width: 120px;
      text-align: center;
      flex: 1;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s ease, background-color 0.3s ease;
      background-color: #f8f9fa;
    }

    .coordinates-input:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    .location-set {
      background: #f5f5f5;
      border: 2px solid #e0e0e0;
      color: #666;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
      margin-left: 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .location-set:enabled {
      background: #2196F3;
      border-color: #2196F3;
      color: white;
      cursor: pointer;
    }

    .location-set:enabled:hover {
      background: #1976D2;
      border-color: #1976D2;
    }

    .location-set:disabled {
      background: #f5f5f5;
      border-color: #e0e0e0;
      color: #ccc;
      cursor: not-allowed;
    }

    .password-toggle {
      background: #f5f5f5;
      border: 2px solid #e0e0e0;
      color: #666;
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
      min-width: 50px;
      text-align: center;
    }

    .password-toggle:hover {
      background: #e8f4ff;
      border-color: #2196F3;
      color: #2196F3;
    }

    .location-set {
      background: #f5f5f5;
      border: 2px solid #e0e0e0;
      color: #666;
      padding: 10px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 10px;
      transition: all 0.3s ease;
      min-width: 40px;
      text-align: center;
    }

    .location-set:hover {
      background: #e8f4ff;
      border-color: #2196F3;
      color: #2196F3;
    }

    .nested-settings {
      margin-left: 15px;
      margin-top: 10px;
      padding-left: 10px;
      border-left: 2px solid #e0e0e0;
    }

    .nested-settings .setting-group {
      background: white;
      margin-bottom: 10px;
    }

    @media (max-width: 640px) {
      .container {
        margin: 5px;
        border-radius: 8px;
      }

      .content {
        padding: 15px;
      }

      .setting-group {
        padding: 12px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>
        <img src="logo.png" alt="Logo" width="24" />
        Aura2 Settings
      </h1>
    </div>

    <!-- Detect Location -->
    <div class="content">
      <div class="setting-group location-section">
        <button class="detect-btn" onclick="detectLocation()"><img src="map_search.svg" alt="Map Icon" width="20"
            height="20" /> Detect Location</button>
        <div class="location-info">
          <div id="locationStatus">%WEATHER_CITY%, %WEATHER_REGION%</div>

          <div class="toggle-container" style="margin-top: 10px;">
            <label class="toggle-switch">
              <input type="checkbox" id="editCoordinates" onchange="toggleCoordinateEditing(this.checked)" />
              <span class="toggle-slider"></span>
            </label>
            <span class="setting-label">Edit location manually</span>
          </div>

          <div id="coordinates" class="coordinates">
            Latitude: <span><input type="number" id="latitude" class="coordinates-input" value="%CURRENT_LAT%" readonly
                step="0.000001" min="-90" max="90" /></span> /
            Longitude: <span><input type="number" id="longitude" class="coordinates-input" value="%CURRENT_LON%"
                readonly step="0.000001" min="-180" max="180" /></span>
            <button id="updateLocation" type="button" class="location-set" disabled onclick="saveCoordinates()"><img
                src="edit_location.svg" alt="Update Location" width="16" height="16" /></button>
          </div>
        </div>
      </div>

      <!-- Display Brightness -->
      <div class="setting-group">
        <label class="setting-label">Display Brightness</label>
        <div class="brightness-container">
          <input type="range" min="0" max="255" value="%BRIGHTNESS_VALUE%" id="brightnessSlider"
            class="brightness-slider" oninput="updateBrightness(this.value)" />
        </div>
      </div>

      <!-- Clock Format -->
      <div class="setting-group">
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="clockFormat24" onchange="updateClockFormat(this.checked)" %CLOCK_24H_CHECKED% />
            <span class="toggle-slider"></span>
          </label>
          <span class="setting-label">Use 24-hour clock format</span>
        </div>
      </div>

      <!-- Temperature Format -->
      <div class="setting-group">
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="tempFormatF" onchange="updateTempFormat(this.checked)" %TEMP_F_CHECKED% />
            <span class="toggle-slider"></span>
          </label>
          <span class="setting-label">Use Fahrenheit temperature</span>
        </div>
      </div>

      <!-- Dimming -->
      <div class="setting-group">
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="dimAtTime" onchange="updateDimAtTime(this.checked)" %DIM_AT_TIME_CHECKED% />
            <span class="toggle-slider"></span>
          </label>
          <span class="setting-label">Auto-dim display at night</span>
        </div>

        <div class="nested-settings">
          <div class="setting-group">
            <label class="setting-label">Dim start time</label>
            <input type="time" id="dimStartTime" value="%DIM_START_TIME%" class="time-input"
              onchange="updateDimStartTime(this.value)" />
          </div>
          <div class="setting-group">
            <label class="setting-label">Dim end time</label>
            <input type="time" id="dimEndTime" value="%DIM_END_TIME%" class="time-input"
              onchange="updateDimEndTime(this.value)" />
          </div>
        </div>
      </div>

      <!-- Daylight Saving Time -->
      <div class="setting-group">
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="useDST" onchange="updateUseDST(this.checked)" %USE_DST_CHECKED% />
            <span class="toggle-slider"></span>
          </label>
          <span class="setting-label">Enable Daylight Saving Time</span>
        </div>
      </div>

      <!-- MQTT Configuration -->
      <div class="setting-group">
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="useMQTT" onchange="updateUseMQTT(this.checked)" %USE_MQTT_CHECKED% />
            <span class="toggle-slider"></span>
          </label>
          <span class="setting-label">Use MQTT Configuration</span>
        </div>
        <div class="nested-settings">
          <div class="setting-group">
            <label class="setting-label">Username</label>
            <input type="text" id="mqttUsername" class="text-input" placeholder="Enter MQTT username"
              onchange="updateMqttUsername(this.value)" value="%MQTT_USERNAME%" />
          </div>
          <div class="setting-group">
            <label class="setting-label">Password</label>
            <div class="input-group">
              <input type="password" id="mqttPassword" class="text-input" placeholder="Enter MQTT password"
                onchange="updateMqttPassword(this.value)" value="%MQTT_PASSWORD%" />
              <button type="button" class="password-toggle" onclick="togglePasswordVisibility()"><img
                  src="visibility.svg" alt="Toggle Password Visibility" width="16" height="16" /></button>
            </div>
          </div>
        </div>
      </div>

      <!-- NATS Configuration -->
      <div class="setting-group">
        <div class="toggle-container">
          <label class="toggle-switch">
            <input type="checkbox" id="useNATS" onchange="updateUseNATS(this.checked)" %USE_NATS_CHECKED% />
            <span class="toggle-slider"></span>
          </label>
          <span class="setting-label">Use NATS Configuration</span>
        </div>
        <div class="nested-settings">
          <div class="setting-group">
            <label class="setting-label">Server</label>
            <input type="text" id="natsServer" class="text-input" placeholder="Enter NATS server"
              onchange="updateNatsServer(this.value)" value="%NATS_SERVER%" />
          </div>
          <div class="setting-group">
            <label class="setting-label">Username</label>
            <input type="text" id="natsUsername" class="text-input" placeholder="Enter NATS username"
              onchange="updateNatsUsername(this.value)" value="%NATS_USER%" />
          </div>
          <div class="setting-group">
            <label class="setting-label">Password</label>
            <div class="input-group">
              <input type="password" id="natsPassword" class="text-input" placeholder="Enter NATS password"
                onchange="updateNatsPassword(this.value)" value="%NATS_PASSWORD%" />
              <button type="button" class="password-toggle" onclick="toggleNatsPasswordVisibility()"><img
                  src="visibility.svg" alt="Toggle Password Visibility" width="16" height="16" /></button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
  </div>

  <script>
    function detectLocation() {
      document.getElementById("locationStatus").textContent = "Detecting location...";

      fetch("/detectLocation", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({})
      })
        .then(res => res.json())
        .then(data => {
          if (data.status === "ok") {
            const lat = data.latitude;
            const lon = data.longitude;
            const location = data.city && data.region ? `${data.city}, ${data.region}` : `${lat}, ${lon}`;

            document.getElementById("locationStatus").textContent = location;

            var latInput = document.getElementById("latitude");
            latInput.readOnly = false;
            latInput.value = lat;
            latInput.readOnly = true;

            var lonInput = document.getElementById("longitude");
            lonInput.readOnly = false;
            lonInput.value = lon;
            lonInput.readOnly = true;

            console.log("Location detected and saved to ESP32");
          } else {
            document.getElementById("locationStatus").textContent = `Error: ${data.error}`;
            console.error("Location detection failed:", data.error);
          }
        })
        .catch(err => {
          document.getElementById("locationStatus").textContent = "Detection failed";
          console.error("Network error:", err);
        });
    }

    function updateBrightness(val) {
      fetch("/setBrightness", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ value: parseInt(val) }),
      });
    }

    function updateClockFormat(is24Hour) {
      fetch("/setClockFormat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ format24: is24Hour }),
      });
    }

    function updateTempFormat(isFahrenheit) {
      fetch("/setTempFormat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ useF: isFahrenheit }),
      });
    }

    function updateDimAtTime(isEnabled) {
      fetch("/setDimAtTime", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ enabled: isEnabled }),
      });
    }

    function updateDimStartTime(time) {
      fetch("/setDimStartTime", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ startTime: time }),
      });
    }

    function updateDimEndTime(time) {
      fetch("/setDimEndTime", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ endTime: time }),
      });
    }

    function updateUseDST(isEnabled) {
      fetch("/setUseDST", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ enabled: isEnabled }),
      });
    }

    function updateUseMQTT(isEnabled) {
      fetch("/setUseMQTT", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ enabled: isEnabled }),
      });
    }

    function toggleCoordinateEditing(isEnabled) {
      const latInput = document.getElementById("latitude");
      const lonInput = document.getElementById("longitude");
      const updateButton = document.getElementById("updateLocation");

      latInput.readOnly = !isEnabled;
      lonInput.readOnly = !isEnabled;
      updateButton.disabled = !isEnabled;

      if (isEnabled) {
        latInput.style.backgroundColor = "#fff";
        lonInput.style.backgroundColor = "#fff";
      } else {
        latInput.style.backgroundColor = "#f8f9fa";
        lonInput.style.backgroundColor = "#f8f9fa";
      }
    }

    function saveCoordinates() {
      const latInput = document.getElementById("latitude");
      const lonInput = document.getElementById("longitude");
      const lat = parseFloat(latInput.value);
      const lon = parseFloat(lonInput.value);

      // Validate coordinates
      if (isNaN(lat) || lat < -90 || lat > 90) {
        alert("Please enter a valid latitude (-90 to 90)");
        return;
      }

      if (isNaN(lon) || lon < -180 || lon > 180) {
        alert("Please enter a valid longitude (-180 to 180)");
        return;
      }

      // Send to server
      fetch("/setLocation", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ latitude: lat, longitude: lon }),
      })
        .then(response => {
          if (response.ok) {
            // Refresh the page to update all values
            window.location.reload();
          }
        });
    }

    function updateMqttUsername(username) {
      fetch("/setMqttUsername", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ username: username }),
      });
    }

    function updateMqttPassword(password) {
      fetch("/setMqttPassword", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ password: password }),
      });
    }

    function togglePasswordVisibility() {
      const passwordField = document.getElementById("mqttPassword");
      const toggleButton = passwordField.nextElementSibling;

      if (passwordField.type === "password") {
        passwordField.type = "text";
        toggleButton.innerHTML = '<img src="visibility_off.svg" alt="Toggle Password Visibility" width="16" height="16" />';
      } else {
        passwordField.type = "password";
        toggleButton.innerHTML = '<img src="visibility.svg" alt="Toggle Password Visibility" width="16" height="16" />';
      }
    }
    
    function updateUseNATS(isEnabled) {
      fetch("/setUseNATS", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ enabled: isEnabled }),
      });
    }

    function updateNatsServer(server) {
      fetch("/setNatsServer", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ server: server }),
      });
    }

    function updateNatsUsername(username) {
      fetch("/setNatsUsername", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ username: username }),
      });
    }

    function updateNatsPassword(password) {
      fetch("/setNatsPassword", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ password: password }),
      });
    }

    function toggleNatsPasswordVisibility() {
      const passwordField = document.getElementById("natsPassword");
      const toggleButton = passwordField.nextElementSibling;

      if (passwordField.type === "password") {
        passwordField.type = "text";
        toggleButton.innerHTML = '<img src="visibility_off.svg" alt="Toggle Password Visibility" width="16" height="16" />';
      } else {
        passwordField.type = "password";
        toggleButton.innerHTML = '<img src="visibility.svg" alt="Toggle Password Visibility" width="16" height="16" />';
      }
    }
  </script>
</body>

</html>